<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attribution Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .output {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .fingerprint-test {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>MonkeyBlock Attribution Test Page</h1>
    
    <div class="fingerprint-test">
        <h2>1. Fingerprint Test</h2>
        <button class="test-button" onclick="testFingerprint()">Test Fingerprint Generation</button>
        <div id="fingerprint-output" class="output"></div>
    </div>

    <div>
        <h2>2. Attribution Storage Test</h2>
        <p>Add some test UTM parameters to URL first:</p>
        <button class="test-button" onclick="addTestUTM()">Add Test UTM Parameters</button>
        
        <p>Then test the install button:</p>
        <a href="https://chromewebstore.google.com/detail/monkey-block/ggccjkdgmlclpigflghjjkgeblgdgffe" 
           class="test-button" 
           data-track="install" 
           data-location="test-page"
           style="display: inline-block; text-decoration: none;">
           Test Install Button
        </a>
        
        <button class="test-button" onclick="checkAttribution()">Check Stored Attribution</button>
        <button class="test-button" onclick="clearAttribution()">Clear Attribution</button>
        
        <div id="attribution-output" class="output"></div>
    </div>

    <!-- Include the necessary scripts -->
    <script src="/js/shared-fingerprint.js"></script>
    
    <script>
        function testFingerprint() {
            const output = document.getElementById('fingerprint-output');
            
            // Test shared fingerprint generator
            if (typeof FingerprintGenerator !== 'undefined') {
                const fp1 = FingerprintGenerator.generate();
                const fp2 = FingerprintGenerator.generate();
                const components = FingerprintGenerator.getComponents();
                
                output.textContent = `FingerprintGenerator available ✓\n\n`;
                output.textContent += `First generation: ${fp1}\n`;
                output.textContent += `Second generation: ${fp2}\n`;
                output.textContent += `Consistent: ${fp1 === fp2 ? '✓ YES' : '✗ NO'}\n\n`;
                output.textContent += `Components:\n${JSON.stringify(components, null, 2)}`;
            } else {
                output.textContent = 'FingerprintGenerator NOT FOUND ✗';
            }
        }
        
        function addTestUTM() {
            const url = new URL(window.location);
            url.searchParams.set('utm_source', 'test');
            url.searchParams.set('utm_medium', 'debug');
            url.searchParams.set('utm_campaign', 'attribution-test');
            window.history.pushState({}, '', url);
            
            alert('UTM parameters added! Check the URL.');
        }
        
        function checkAttribution() {
            const output = document.getElementById('attribution-output');
            
            const preInstall = localStorage.getItem('mb_pre_install_attribution');
            const landing = localStorage.getItem('mb_landing_attribution');
            const cookies = document.cookie.split(';').find(c => c.includes('mb_attr'));
            
            output.textContent = 'Attribution Storage Check:\n\n';
            
            output.textContent += 'Pre-Install Attribution:\n';
            if (preInstall) {
                output.textContent += JSON.stringify(JSON.parse(preInstall), null, 2) + '\n\n';
            } else {
                output.textContent += 'NOT FOUND ✗\n\n';
            }
            
            output.textContent += 'Landing Attribution:\n';
            if (landing) {
                output.textContent += JSON.stringify(JSON.parse(landing), null, 2) + '\n\n';
            } else {
                output.textContent += 'NOT FOUND ✗\n\n';
            }
            
            output.textContent += 'Cookie Attribution:\n';
            if (cookies) {
                output.textContent += cookies + '\n';
                try {
                    const value = cookies.split('=')[1];
                    const decoded = JSON.parse(atob(value));
                    output.textContent += 'Decoded: ' + JSON.stringify(decoded, null, 2);
                } catch (e) {
                    output.textContent += 'Failed to decode: ' + e.message;
                }
            } else {
                output.textContent += 'NOT FOUND ✗';
            }
        }
        
        function clearAttribution() {
            localStorage.removeItem('mb_pre_install_attribution');
            localStorage.removeItem('mb_landing_attribution');
            localStorage.removeItem('mb_attribution_timestamp');
            
            // Clear cookie
            document.cookie = 'mb_attr=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            
            alert('Attribution cleared!');
            checkAttribution();
        }
        
        // Manual attribution tracking for testing
        window.trackTestAttribution = function() {
            const fingerprint = FingerprintGenerator ? FingerprintGenerator.generate() : 'test-fp';
            const userId = `user_web_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const attributionData = {
                userId: userId,
                deviceId: fingerprint,
                fingerprint: fingerprint,
                utm: {
                    utm_source: new URLSearchParams(window.location.search).get('utm_source') || 'direct',
                    utm_medium: new URLSearchParams(window.location.search).get('utm_medium') || 'none',
                    utm_campaign: new URLSearchParams(window.location.search).get('utm_campaign') || 'none'
                },
                referrer: document.referrer,
                landing_page: window.location.pathname,
                button_location: 'test-manual',
                timestamp: Date.now(),
                source_platform: 'website'
            };
            
            localStorage.setItem('mb_pre_install_attribution', JSON.stringify(attributionData));
            
            console.log('Attribution stored manually:', attributionData);
            checkAttribution();
        };
    </script>
</body>
</html>
